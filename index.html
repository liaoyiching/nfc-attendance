<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>NFC æ‰“å¡ï¼ˆè¡Œå‹•å¤§æŒ‰éˆ•ï¼‰</title>
<style>
  :root{--bg:#F4F6F9;--card:#ffffff;--accent:#0b84ff;--muted:#666}
  html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial}
  body{background:var(--bg);display:flex;align-items:center;justify-content:center;padding:20px}
  .wrap{width:100%;max-width:460px}
  .card{background:var(--card);border-radius:14px;padding:18px;box-shadow:0 6px 18px rgba(10,20,40,0.08)}
  h1{margin:0;font-size:20px}
  p.sub{color:var(--muted);margin:8px 0 18px;font-size:14px}
  .big-btn{display:block;width:100%;padding:18px;border-radius:12px;border:0;font-size:18px;background:linear-gradient(180deg,var(--accent),#066fe0);color:#fff;box-shadow:0 6px 18px rgba(11,132,255,0.18);margin-top:10px}
  .big-btn.secondary{background:#eee;color:#111;box-shadow:none}
  .small{font-size:13px;color:var(--muted);margin-top:10px;text-align:center}
  input{width:100%;padding:12px;border-radius:10px;border:1px solid #e6e9ef;margin-top:8px;font-size:16px}
  .row{display:flex;gap:8px}
  .pill{display:inline-block;padding:6px 10px;border-radius:999px;background:#f0f4ff;color:#034ea2;font-weight:600;font-size:13px}
  .hidden{display:none}
  #records{max-height:300px;overflow:auto;margin-top:12px}
  .rec{padding:10px;border-bottom:1px solid #f1f1f3;font-size:14px}
  footer{margin-top:14px;text-align:center;color:var(--muted);font-size:12px}
</style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>NFC æ‰“å¡ç³»çµ±</h1>
      <p class="sub">è«‹å°‡æ‰‹æ©Ÿè²¼è¿‘ NFC æ¨™ç±¤æˆ–æŒ‰ä¸‹ã€Œæ‰“å¡ã€æŒ‰éˆ•ã€‚</p>

      <div id="status" class="pill">è¼‰å…¥ä¸­â€¦</div>

      <!-- REGISTER -->
      <div id="register" class="hidden">
        <input id="name" placeholder="å§“å" autocomplete="name" />
        <input id="phone" placeholder="é›»è©±" inputmode="tel" />
        <input id="employee_no" placeholder="å“¡å·¥ç·¨è™Ÿ" />
        <button id="btn-register" class="big-btn">å®Œæˆè¨»å†Šä¸¦æ‰“å¡</button>
      </div>

      <!-- ATTENDANCE -->
      <div id="attendance" class="hidden">
        <p id="me" style="margin:8px 0 0;font-weight:600"></p>
        <button id="btn-punch" class="big-btn">ğŸ“ æ‰“å¡</button>
        <button id="btn-history" class="big-btn secondary">æˆ‘çš„æ‰“å¡ç´€éŒ„</button>

        <div id="records" class="hidden" aria-live="polite"></div>
      </div>

      <div id="msg" class="small" role="status"></div>
    </div>

    <footer>è£ç½®IDï¼š<span id="device_id" style="font-family:monospace"></span></footer>
  </div>

<script>
/* ========== é‡è¦è¨­å®šï¼šæŠŠä½ çš„ Apps Script Web App URL æ”¾åœ¨é€™è£¡ ========== */
const API_URL = "https://script.google.com/macros/s/AKfycbyzXMm-mVeNEY1dZlmkdFluG2f3X5_OfTBykr_3vkEbNU9zMQbLqjYGeetE-5b2YPPk/exec";
/* ===================================================================== */

const $ = id => document.getElementById(id);
const statusEl = $("status");
const msgEl = $("msg");
const registerEl = $("register");
const attendanceEl = $("attendance");
const recordsEl = $("records");
const deviceEl = $("device_id");
const meEl = $("me");

let device_id = localStorage.getItem("device_id");
let user = null; // { user_id, name, phone, employee_no, device_id }

function genId(prefix='u-'){ return prefix + Date.now().toString(36) + Math.random().toString(36).slice(2,8); }
function setStatus(s){ statusEl.textContent = s; }
function setMsg(t){ msgEl.textContent = t; setTimeout(()=>{ if(msgEl.textContent===t) msgEl.textContent=''; }, 4000); }

/* API POST - ä¸åŠ  headersï¼ˆApps Script ContentService å¯æ¥å—ï¼‰ */
async function apiPost(body){
  try{
    const res = await fetch(API_URL, {
      method: "POST",
      body: JSON.stringify(body)
    });
    return await res.json();
  }catch(e){
    console.error("apiPost error", e);
    throw e;
  }
}

/* API GET */
async function apiGet(params){
  const qs = new URLSearchParams(params).toString();
  const res = await fetch(API_URL + "?" + qs);
  return await res.json();
}

/* è®€æœ¬æ©Ÿ user è³‡è¨Š */
function loadLocalUser(){
  const uid = localStorage.getItem("user_id");
  if(!uid) return null;
  return {
    user_id: uid,
    name: localStorage.getItem("name"),
    phone: localStorage.getItem("phone"),
    employee_no: localStorage.getItem("employee_no"),
    device_id: localStorage.getItem("device_id")
  };
}

/* å­˜æœ¬æ©Ÿ user è³‡è¨Š */
function saveLocalUser(u){
  localStorage.setItem("user_id", u.user_id);
  localStorage.setItem("name", u.name);
  localStorage.setItem("phone", u.phone);
  localStorage.setItem("employee_no", u.employee_no);
  localStorage.setItem("device_id", u.device_id);
}

/* å–å¾— GPSï¼ˆå›å‚³å­—ä¸²ï¼‰ */
function getLocation(timeoutMs=8000){
  return new Promise(resolve=>{
    if(!navigator.geolocation){
      resolve("NoGPS");
      return;
    }
    let done=false;
    navigator.geolocation.getCurrentPosition(pos=>{
      if(done) return;
      done=true;
      resolve(`${pos.coords.latitude},${pos.coords.longitude}`);
    }, err=>{
      if(done) return;
      done=true;
      resolve("GPSæ‹’çµ•");
    }, { enableHighAccuracy:true, timeout: timeoutMs });
    setTimeout(()=>{ if(!done){ done=true; resolve("GPS_TIMEOUT"); } }, timeoutMs+200);
  });
}

/* åˆå§‹åŒ– */
async function init(){
  try{
    setStatus("åˆå§‹åŒ–è£ç½®â€¦");
    // device_id
    if(!device_id){
      device_id = "dev-" + Math.random().toString(36).slice(2,12);
      localStorage.setItem("device_id", device_id);
    }
    deviceEl.textContent = device_id;

    // å…ˆçœ‹ local storage æœ‰æ²’æœ‰ user
    const local = loadLocalUser();
    if(local && local.device_id === device_id){
      user = local;
      // ä¹Ÿå¯å‘å¾Œç«¯ç¢ºèªï¼ˆå®¹éŒ¯ï¼‰
      setStatus("æª¢æŸ¥ä½¿ç”¨è€…è³‡æ–™â€¦");
      const resp = await apiPost({ action: "getUser", device_id: device_id });
      // å¾Œç«¯å¯èƒ½å›å‚³ä¸åŒæ ¼å¼ï¼šæ”¯æ´å¤šç¨®åˆ¤æ–·
      if(resp && (resp.status === "found" || resp.status === "success" || resp.user || resp.user_id || resp.user_id===undefined===false)){
        // è‹¥å¾Œç«¯å› user in resp.user
        if(resp.user){ user = Object.assign(user, resp.user); }
        // show attendance UI
        showAttendance();
        setStatus("æº–å‚™å°±ç·’");
        return;
      } else {
        // è‹¥å¾Œç«¯æ²’æ‰¾åˆ°ï¼Œå°±ç•¶æˆæœªè¨»å†Šï¼ˆä½†æœ¬æ©Ÿä»æœ‰è³‡æ–™ï¼‰ï¼›ç‚ºå®‰å…¨èµ·è¦‹é¡¯ç¤ºè¨»å†Šç•«é¢è®“ä½¿ç”¨è€…è¦†æ ¸
        setStatus("è«‹ç¢ºèªè³‡æ–™æˆ–é‡æ–°è¨»å†Š");
        showRegister();
        return;
      }
    }

    // è‹¥ local ç„¡ userï¼Œå˜—è©¦ç”¨ device_id æŸ¥å¾Œç«¯
    setStatus("æª¢æŸ¥æ˜¯å¦å·²è¨»å†Šï¼ˆä¼ºæœå™¨ï¼‰â€¦");
    const result = await apiPost({ action: "getUser", device_id: device_id });
    // å¯èƒ½å›å‚³ {status:"found", user:{...}} æˆ–ç›´æ¥ user object æˆ– {status:"not_found"}
    if(result && result.status === "found" && result.user){
      user = result.user;
      saveLocalUser(user);
      showAttendance();
      setStatus("æ­¡è¿å›ä¾†");
      return;
    }
    if(result && result.status === "success" && result.user){
      user = result.user;
      saveLocalUser(user);
      showAttendance();
      setStatus("æ­¡è¿å›ä¾†");
      return;
    }
    // æœ‰äº›å¯¦ä½œæœƒç›´æ¥å›å‚³ user fields (user_id present)
    if(result && result.user_id){
      user = {
        user_id: result.user_id,
        name: result.name || localStorage.getItem("name") || "",
        phone: result.phone || localStorage.getItem("phone") || "",
        employee_no: result.employee_no || localStorage.getItem("employee_no") || "",
        device_id: device_id
      };
      saveLocalUser(user);
      showAttendance();
      setStatus("æ­¡è¿å›ä¾†");
      return;
    }

    // è‹¥éƒ½æ²’æœ‰ï¼Œé¡¯ç¤ºè¨»å†Š
    setStatus("æœªè¨»å†Š - è«‹è¨»å†Š");
    showRegister();

  }catch(err){
    console.error("init error", err);
    setStatus("åˆå§‹åŒ–éŒ¯èª¤");
    showRegister();
  }
}

/* é¡¯ç¤ºè¨»å†Šå€ */
function showRegister(){
  registerEl.classList.remove("hidden");
  attendanceEl.classList.add("hidden");
}

/* é¡¯ç¤ºæ‰“å¡å€ */
function showAttendance(){
  registerEl.classList.add("hidden");
  attendanceEl.classList.remove("hidden");
  meEl.textContent = `${user.name || "æœªçŸ¥å§“å"} ï¼ˆ${user.employee_no || ""}ï¼‰`;
}

/* è¨»å†Šæµç¨‹ */
async function doRegister(){
  const name = document.getElementById("name").value.trim();
  const phone = document.getElementById("phone").value.trim();
  const employee_no = document.getElementById("employee_no").value.trim();
  if(!name || !phone || !employee_no){ setMsg("è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½"); return; }

  setStatus("è¨»å†Šä¸­â€¦");
  const newUser = {
    user_id: genId("u-"),
    name, phone, employee_no,
    device_id
  };

  try{
    const resp = await apiPost({ action: "register", ...newUser });
    // æ”¯æ´å¤šç¨®å¾Œç«¯å›å‚³æ ¼å¼
    if(resp && (resp.status === "ok" || resp.status === "success")){
      saveLocalUser(newUser);
      user = newUser;
      setMsg("è¨»å†ŠæˆåŠŸ");
      showAttendance();
      setStatus("è¨»å†Šå®Œæˆ");
      // è¨»å†Šå®Œæˆå¾Œç›´æ¥æ‰“å¡ï¼ˆå¯ç•™åœ¨å‰ç«¯æ±ºå®šï¼‰
      await doPunch();
      return;
    } else {
      console.warn("register resp", resp);
      setMsg("è¨»å†Šå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
      setStatus("è¨»å†Šå¤±æ•—");
    }
  }catch(e){
    console.error(e);
    setMsg("è¨»å†ŠéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ç¶²è·¯");
    setStatus("ç¶²è·¯éŒ¯èª¤");
  }
}

/* æ‰“å¡æµç¨‹ */
async function doPunch(){
  setStatus("å–å¾— GPSâ€¦");
  const loc = await getLocation();
  setStatus("é€å‡ºæ‰“å¡è³‡æ–™â€¦");

  // æ§‹é€ é€å‡ºè³‡æ–™ï¼ˆå¾Œç«¯æœƒä»¥ device_id æ‰¾å°æ‡‰ userï¼Œè‹¥å¾Œç«¯éœ€è¦ user_id ä¹Ÿä¸€ä½µé€ï¼‰
  const payload = {
    action: "attendance",
    user_id: user?.user_id || localStorage.getItem("user_id") || null,
    name: user?.name || localStorage.getItem("name") || "",
    location: loc,
    device_id: device_id
  };

  try{
    const resp = await apiPost(payload);
    if(resp && (resp.status === "ok" || resp.status === "success")){
      setMsg("æ‰“å¡æˆåŠŸ");
      setStatus("æ‰“å¡å®Œæˆ");
    } else {
      console.warn("attendance resp", resp);
      setMsg("æ‰“å¡å¤±æ•—");
      setStatus("æ‰“å¡å¤±æ•—");
    }
  }catch(e){
    console.error("doPunch error", e);
    setMsg("ç„¡æ³•é€£ç·šï¼Œè«‹ç¨å¾Œå†è©¦");
    setStatus("ç¶²è·¯éŒ¯èª¤");
  }
}

/* æŸ¥è©¢å€‹äººæ‰“å¡ç´€éŒ„ï¼ˆGETï¼‰ */
async function showMyRecords(){
  setStatus("è®€å–ç´€éŒ„â€¦");
  recordsEl.innerHTML = "";
  recordsEl.classList.remove("hidden");
  try{
    const uid = user?.user_id || localStorage.getItem("user_id");
    if(!uid){ setMsg("æ‰¾ä¸åˆ° user_id"); setStatus("éŒ¯èª¤"); return; }
    const resp = await apiGet({ action: "attendance_records", user_id: uid });
    if(resp && resp.status === "success" && Array.isArray(resp.records)){
      if(resp.records.length === 0){
        recordsEl.innerHTML = "<div class='rec'>å°šç„¡æ‰“å¡ç´€éŒ„</div>";
      } else {
        recordsEl.innerHTML = resp.records.map(r=>{
          const t = (new Date(r.timestamp)).toLocaleString();
          return `<div class="rec"><div style="font-weight:600">${r.name||""}</div><div style="color:#666">${t}</div><div style="font-size:13px;color:#666">${r.location||""}</div></div>`;
        }).join("");
      }
      setStatus("ç´€éŒ„è¼‰å…¥å®Œæˆ");
    } else if(resp && Array.isArray(resp.records)){ // æŸäº›å¾Œç«¯æœƒç›´æ¥å› records
      if(resp.records.length === 0) recordsEl.innerHTML = "<div class='rec'>å°šç„¡æ‰“å¡ç´€éŒ„</div>";
      else recordsEl.innerHTML = resp.records.map(r=>`<div class="rec"><div style="font-weight:600">${r.name||''}</div><div style="color:#666">${(new Date(r.timestamp)).toLocaleString()}</div><div style="font-size:13px;color:#666">${r.location||''}</div></div>`).join("");
      setStatus("ç´€éŒ„è¼‰å…¥å®Œæˆ");
    } else {
      console.warn("records resp", resp);
      recordsEl.innerHTML = "<div class='rec'>è®€å–å¤±æ•—</div>";
      setStatus("è®€å–å¤±æ•—");
    }
  }catch(e){
    console.error("showMyRecords error", e);
    recordsEl.innerHTML = "<div class='rec'>è®€å–éŒ¯èª¤</div>";
    setStatus("ç¶²è·¯éŒ¯èª¤");
  }
}

/* ========== Event bindings ========== */
document.getElementById("btn-register").addEventListener("click", doRegister);
document.getElementById("btn-punch").addEventListener("click", doPunch);
document.getElementById("btn-history").addEventListener("click", showMyRecords);

/* å•Ÿå‹• */
init();
</script>
</body>
</html>
